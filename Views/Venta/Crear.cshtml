@model ProyectoCatedra.Models.Venta
@{
    var productos = ViewBag.Productos as List<Producto>;
}

<h2>Registrar Venta</h2>

<div>
    <label for="productoSelect">Producto:</label>
    <select id="productoSelect" class="form-control">
        @foreach (var producto in productos)
        {
            <option value="@producto.Id" data-nombre="@producto.Nombre" data-precio="@producto.Precio">
                @producto.Nombre ($@producto.Precio)
            </option>
        }
    </select>

    <label for="cantidadInput">Cantidad:</label>
    <input type="number" id="cantidadInput" class="form-control" min="1" value="1" />

    <button type="button" class="btn btn-primary mt-2" onclick="agregarProducto()">Agregar</button>
</div>

<form asp-action="Crear" method="post">
    <div class="form-group">
        <label>Nombre del Cliente</label>
        <input type="text" name="NombreCliente" class="form-control" required />
    </div>
    <div class="form-group">
        <label>Teléfono del Cliente</label>
        <input type="text" name="TelefonoCliente" class="form-control" required />
    </div>

    <table class="table mt-4">
        <thead>
            <tr><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Acción</th></tr>
        </thead>
        <tbody id="tablaProductos"></tbody>
    </table>

    <input type="hidden" name="productoIds" />
    <input type="hidden" name="cantidades" />

    <button type="submit" class="btn btn-success">Generar Ticket</button>
</form>

@section Scripts {
    <script>
        const productosSeleccionados = [];

        function agregarProducto() {
            const select = document.getElementById("productoSelect");
            const cantidad = parseInt(document.getElementById("cantidadInput").value);
            const id = parseInt(select.value);
            const nombre = select.options[select.selectedIndex].getAttribute("data-nombre");
            const precio = parseFloat(select.options[select.selectedIndex].getAttribute("data-precio"));

            if (cantidad > 0) {
                productosSeleccionados.push({ id, nombre, cantidad, precio });
                renderTabla();
            }
        }

        function eliminarProducto(index) {
            productosSeleccionados.splice(index, 1);
            renderTabla();
        }

        function renderTabla() {
            const tabla = document.getElementById("tablaProductos");
            tabla.innerHTML = "";

            const ids = [];
            const cantidades = [];

            productosSeleccionados.forEach((prod, i) => {
                tabla.innerHTML += `
                    <tr>
                        <td>${prod.nombre}</td>
                        <td>${prod.cantidad}</td>
                        <td>$${(prod.precio * prod.cantidad).toFixed(2)}</td>
                        <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${i})">Eliminar</button></td>
                    </tr>`;
                ids.push(prod.id);
                cantidades.push(prod.cantidad);
            });

            document.getElementsByName("productoIds")[0].value = ids.join(",");
            document.getElementsByName("cantidades")[0].value = cantidades.join(",");
        }
    </script>
}

